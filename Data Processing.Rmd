---
title: "Data"
author: "Ethan Shen"
date: "9/1/2020"
output: html_document
---

```{r}
library(tidyverse)
library(jsonlite)
```


```{r}
league = read_csv("586003-1093265-bundle-archive/match_data_version1.csv")
champions = read_csv("riot_champion.csv") %>%
  select(key, name)
```


```{r}
# s = Sys.time()
# load("participants.RData")
# print(Sys.time() - s)
# 
# s = Sys.time()
# league_df = sample_n(league, 100) %>%
#   mutate(rownum = row_number())

league_df = league %>%
  mutate(rownum = row_number())

find_list_columns = function(x) {
  col_check = map_dfr(x, 
                      ~ map(., length)) %>%
    map_lgl(~ any(. > 1 | . == 0, na.rm = TRUE)) # check for null list  elements 
  
  list_cols = names(col_check)[col_check] 
  
  fix_list_cols = function(entry, name) {
    if (name %in% list_cols) {
      list(entry)
    } else {
      entry
    }
  }
  
  map_dfr(x,
          function(char) {
            map2(char, names(char), fix_list_cols) %>%
              as_tibble(validate = NULL
              )
          }
  ) 
}
```


```{r}
if (file.exists("participants.RData")) {
  print("The file participants.RData exists.")
  #load(file = "participants.RData")
} else {
  par_list = list()
  for (i in 1:nrow(league_df)){
    pp = league_df$participants[i]
    pp = pp %>% str_replace_all("'",'"') %>%
      str_replace_all('False', '"False"') %>%
      str_replace_all('True', '"True"')
    write(pp, paste0("/Users/ethanshen/Documents/College/Fa20/STA 440/par.json"))
    par_df = find_list_columns(read_json("/Users/ethanshen/Documents/College/Fa20/STA 440/par.json")) %>%
      mutate(rownum = i)
    par_list[[i]] = par_df
  }
  participants_df = do.call(bind_rows, par_list)
  save(participants_df, file = "participants.RData")
}

#
#
#
if (file.exists("summoners.RData")) {
  print("The file summoners.RData exists.")
  #load(file = "summoners.RData")
} else {
  par_id_list = list()
  for (i in 1:nrow(league_df)){
    pp_id = league_df$participantIdentities[i]
    pp_id = pp_id %>% str_replace_all("'",'"') #%>% str_replace_all('False', '"False"') # %>% str_replace_all('True', '"True"')
    write(pp_id, paste0("/Users/ethanshen/Documents/College/Fa20/STA 440/par_id.json"))
    par_id_df = find_list_columns(read_json("/Users/ethanshen/Documents/College/Fa20/STA 440/par_id.json")) %>%
      mutate(rownum = i)
    par_id_list[[i]] = par_id_df
  }
  par_id_df = do.call(bind_rows, par_id_list)
  player_df = find_list_columns(par_id_df$player)
  player_info = bind_cols(par_id_df %>% select(-player),
                          player_df %>% select(summonerName, summonerId))
  
  save(player_info, file = "summoners.RData")
  
  league_df_w_participants = right_join(league_df %>% 
                                          select(-participants, -participantIdentities), 
                                        inner_join(
                                          participants_df, 
                                          player_info, 
                                          by = c("participantId", "rownum")
                                        ))
}
#
#
#
#

if (file.exists("timeline.Rdata")) {
  print("The file timeline.Rdata exists.")
  #load(file = "timeline.Rdata")
} else {
  timeline = find_list_columns(league_df_w_participants$timeline)
  save(timeline, file = "timeline.Rdata")
  
  league_df_w_participants <- league_df_w_participants %>% 
    bind_cols(timeline) %>% 
    group_by(rownum, win) %>% 
    filter(sum(lane=="JUNGLE") == 1 & sum(lane=="MIDDLE") == 1 & sum(lane=="TOP") == 1 & sum(lane=="BOTTOM") == 2)
}
#
#
#
#

if (file.exists("timeline_per_min.Rdata")) {
  print("The file timeline.Rdata exists.")
  #load(file = "timeline_per_min.Rdata")
} else {
  timeline_list_cols = colnames(league_df_w_participants)[sapply(league_df_w_participants, typeof) == 'list' & str_detect(colnames(league_df_w_participants), "Deltas")]
  
  tl_list = list()
  indexes <- c(1:nrow(league_df_w_participants))
  for (i in 1:length(timeline_list_cols)) {
    col = timeline_list_cols[i]
    tl = league_df_w_participants[[col]] 
    # adding index to each element 
    tl_indexed = mapply(append, tl, indexes, SIMPLIFY = FALSE) 
    
    # assigning a name to the index element, def easier way to do this 
    for (j in 1:nrow(league_df_w_participants)) {
      names(tl_indexed[[j]])[length(tl_indexed[[j]])] <- "index"
    }
    
    tl_df = find_list_columns(tl_indexed)
    colnames(tl_df) = paste(col, colnames(tl_df))
    tl_list[[i]] = tl_df
  }
  
  timeline_per_min = do.call(bind_cols, tl_list) 
  
  timeline_index_cols = colnames(timeline_per_min)[str_detect(colnames(timeline_per_min), "index")]
  
  timeline_per_min = timeline_per_min %>% 
    select(-all_of(timeline_index_cols))
  save(timeline_per_min, file = "timeline_per_min.Rdata")
}

if (file.exists("stats.Rdata")) {
  print("The file stats.Rdata exists.")
  #load(file = "summoners.RData")
} else {
  stats = find_list_columns(league_df_w_participants$stats)
  save(stats, file = "stats.Rdata")
}

if (file.exists("league_df_final.Rdata")) {
  load(file = "league_df_final.Rdata")
} else {
  league_df_final = bind_cols(league_df_w_participants %>% 
                                select(-stats, -timeline, -all_of(timeline_list_cols)),
                              stats,
                              timeline_per_min) %>% 
    select(-(combatPlayerScore:statPerk2))
  
  save(league_df_final, file = "league_df_final.Rdata")
}
```
